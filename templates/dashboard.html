<!DOCTYPE html>
<html>
<head>
    <title>Finger Scanner Data UI</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0; 
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            min-height: 100vh;
            color: #e2e8f0;
            line-height: 1.6;
        }
        .container { 
            max-width: 1400px; 
            margin: 20px auto; 
            background: #2d3748; 
            border-radius: 16px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            overflow: hidden;
            border: 1px solid #4a5568;
        }
        .header { 
            background: linear-gradient(135deg, #1a202c 0%, #2c5282 100%);
            color: #e2e8f0;
            padding: 24px 32px;
            text-align: center;
            border-bottom: 1px solid #4a5568;
        }
        .header img { 
            max-height: 48px; 
            margin-bottom: 16px;
            border-radius: 8px;
        }
        .header h1 { 
            font-size: 2rem; 
            font-weight: 600; 
            margin: 0;
            letter-spacing: -0.025em;
            color: #f7fafc;
        }
        .content { padding: 32px; }
        .filters {
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 32px;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label { 
            font-weight: 500; 
            color: #cbd5e0; 
            margin-bottom: 6px;
            font-size: 0.875rem;
        }
        .form-group input, .form-group select { 
            padding: 10px 12px; 
            border: 2px solid #4a5568; 
            border-radius: 8px; 
            font-size: 0.875rem;
            transition: all 0.2s;
            background: #2d3748;
            color: #e2e8f0;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .btn { 
            padding: 10px 20px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 500; 
            font-size: 0.875rem; 
            text-decoration: none;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { 
            background: #3182ce; 
            color: white; 
        }
        .btn-primary:hover { 
            background: #2c5282; 
            transform: translateY(-1px);
        }
        .btn-secondary { 
            background: #4a5568; 
            color: white; 
        }
        .btn-secondary:hover { 
            background: #2d3748; 
        }
        .btn-success { 
            background: #38a169; 
            color: white; 
        }
        .btn-warning { 
            background: #d69e2e; 
            color: white; 
        }
        .btn-danger { 
            background: #e53e3e; 
            color: white; 
        }
        .btn-info { 
            background: #3182ce; 
            color: white; 
        }
        
        /* Searchable Dropdown Styles */
        .searchable-dropdown {
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #4a5568;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s;
            background: #2d3748;
            color: #e2e8f0;
        }
        .search-input:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        .dropdown-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2d3748;
            border: 2px solid #4a5568;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .dropdown-item {
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #e2e8f0;
            border-bottom: 1px solid #4a5568;
        }
        .dropdown-item:hover {
            background: #4a5568;
        }
        .dropdown-item:last-child {
            border-bottom: none;
        }
        .dropdown-item.selected {
            background: #3182ce;
            color: white;
        }
        
        .legend {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            border: 1px solid #4a5568;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .legend-title {
            font-weight: 600;
            color: #f7fafc;
            margin-bottom: 12px;
            font-size: 0.875rem;
        }
        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: #cbd5e0;
        }
        .legend-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 0.6875rem;
        }
        .badge-capped { background: #742a2a; color: #feb2b2; }
        .badge-auto { background: #744210; color: #fbd38d; }
        .badge-flagged { background: #2a4365; color: #90cdf4; }
        .badge-late-checkout { background: #d69e2e; color: #faf089; }
        .table-container {
            background: #1a202c;
            border-radius: 12px;
            border: 1px solid #4a5568;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        th { 
            background: #2d3748; 
            font-weight: 600; 
            color: #f7fafc; 
            padding: 16px 12px;
            border-bottom: 2px solid #4a5568;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        td { 
            padding: 14px 12px; 
            border-bottom: 1px solid #4a5568;
            font-size: 0.875rem;
            color: #e2e8f0;
        }
        tr:hover { 
            background: #2d3748; 
        }
        .row-capped {
            background: linear-gradient(135deg, #2d1b1b 0%, #742a2a 100%) !important;
            border-left: 4px solid #f56565;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }
        .status-normal { background: #276749; color: #9ae6b4; }
        .status-capped { background: #742a2a; color: #feb2b2; }
        .status-late-checkout { background: #d69e2e; color: #faf089; }
        .status-late-in { background: #d53f8c; color: #f687b3; }
        .status-early-out { background: #4299e1; color: #90cdf4; }
        .time-flagged { 
            color: #fc8181; 
            font-weight: 600;
        }
        .time-late-checkout {
            color: #d69e2e;
            font-weight: 600;
        }
        .time-auto { 
            color: #fbd38d; 
            font-weight: 500;
        }
        .no-data { 
            text-align: center;
            padding: 40px;
            color: #718096;
            font-style: italic;
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #f7fafc;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        @media (max-width: 768px) {
            .container { margin: 10px; }
            .content { padding: 20px; }
            .filters-grid { grid-template-columns: 1fr; }
            .actions { justify-content: center; }
            .legend-items { justify-content: center; }
            table { font-size: 0.75rem; }
            th, td { padding: 10px 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="{{ url_for('static', filename='FDE.png') }}" alt="Logo">
            <h1>Attendance Dashboard</h1>
        </div>
        
        <div class="content">
            <div class="filters">
                <form method="get">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label>Start Date <span style="color: #e53e3e;">*</span></label>
                            <input type="date" name="start_date" value="{{ start_date }}">
                        </div>
                        <div class="form-group">
                            <label>End Date <span style="color: #e53e3e;">*</span></label>
                            <input type="date" name="end_date" value="{{ end_date }}">
                        </div>
                        <div class="form-group">
                            <label>Employee ID</label>
                            <select name="employee_id">
                                <option value="">All Employees</option>
                                {% for emp in all_employees %}
                                <option value="{{ emp }}" {% if emp == employee_id %}selected{% endif %}>{{ emp }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Employee Name</label>
                            <div class="searchable-dropdown">
                                <input type="text" name="employee_name" value="{{ employee_name }}" placeholder="Search employee names..." class="search-input" autocomplete="off">
                                <div class="dropdown-list" style="display: none;">
                                    <div class="dropdown-item" data-value="">All Employee Names</div>
                                    {% for name in all_employee_names %}
                                    <div class="dropdown-item" data-value="{{ name }}">{{ name }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Designation</label>
                            <div class="searchable-dropdown">
                                <input type="text" name="designation" value="{{ designation }}" placeholder="Search designations..." class="search-input" autocomplete="off">
                                <div class="dropdown-list" style="display: none;">
                                    <div class="dropdown-item" data-value="">All Designations</div>
                                    {% for des in all_designations %}
                                    <div class="dropdown-item" data-value="{{ des }}">{{ des }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Device Branch</label>
                            <div class="searchable-dropdown">
                                <input type="text" name="branch_name" value="{{ branch_name }}" placeholder="Search device branches..." class="search-input" autocomplete="off">
                                <div class="dropdown-list" style="display: none;">
                                    <div class="dropdown-item" data-value="">All Branches</div>
                                    {% for branch in all_branches %}
                                    <div class="dropdown-item" data-value="{{ branch }}">{{ branch }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Employee Branch</label>
                            <div class="searchable-dropdown">
                                <input type="text" name="employee_branch" value="{{ employee_branch }}" placeholder="Search employee branches..." class="search-input" autocomplete="off">
                                <div class="dropdown-list" style="display: none;">
                                    <div class="dropdown-item" data-value="">All Employee Branches</div>
                                    {% for emp_branch in all_employee_branches %}
                                    <div class="dropdown-item" data-value="{{ emp_branch }}">{{ emp_branch }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" type="submit">
                            <span>🔍</span> Filter Data
                        </button>
                        <button type="button" class="btn btn-success" onclick="downloadExcel()">
                            <span>📊</span> Download Excel
                        </button>
                        <a href="/unified_management" class="btn btn-primary">
                            <span>🎛️</span> Management Center
                        </a>
                    </div>
                    <div style="margin-top: 12px; font-size: 0.8rem; color: #a0aec0; text-align: center;">
                        <span style="color: #e53e3e;">*</span> Start Date and End Date are required for Excel download
                    </div>
                </form>
            </div>
            <div class="legend">
                <div class="legend-title">📋 Status Legend</div>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-badge badge-capped">SHIFT CAPPED</span>
                        <span>Work hours limited by shift schedule</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge badge-late-checkout">LATE CHECKOUT</span>
                        <span>Checked out after shift end but before noon</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge badge-auto">AUTO END</span>
                        <span>No sign-out recorded</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-badge badge-flagged">MODIFIED</span>
                        <span>Time calculation adjusted</span>
                    </div>
                </div>
            </div>

            <h2 class="section-title">
                <span>📊</span> Attendance Summary
            </h2>
            {% if summary %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Employee ID</th>
                            <th>Employee Name</th>
                            <th>Designation</th>
                            <th>Branch</th>
                            <th>Date</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Hours Worked</th>
                            <th>Shift</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in summary %}
                        <tr {% if row.shift_capped %}class="row-capped"{% endif %}>
                            <td><strong>{{ row.employee_id }}</strong></td>
                            <td><strong>{{ row.employee_name if row.employee_name else '-' }}</strong></td>
                            <td>{{ row.designation if row.designation else '-' }}</td>
                            <td>{{ row.employee_branch if row.employee_branch else '-' }}</td>
                            <td>{{ row.day }}</td>
                            <td>{{ row.start_time.strftime('%H:%M') if row.start_time else '-' }}</td>
                            <td>
                                {% if row.shift_flag == "late checkout" %}
                                    <span class="time-late-checkout" title="Late checkout - at or past shift end (or 12:00 if no shift)">{{ row.end_time.strftime('%H:%M') }} 🕐</span>
                                {% elif row.end_time and row.end_time.strftime('%H:%M:%S') == '23:59:59' %}
                                    <span class="time-auto" title="Auto-calculated end time">{{ row.end_time.strftime('%H:%M') }} ⏰</span>
                                {% else %}
                                    {{ row.end_time.strftime('%H:%M') if row.end_time else '-' }}
                                {% endif %}
                            </td>
                            <td>
                                {% if row.shift_flag == "late checkout" %}
                                    <span class="time-late-checkout" title="Actual time worked including late checkout (at or past shift end/12:00)">{{ row.time_spent }} 🔄</span>
                                {% elif row.shift_capped %}
                                    <span class="time-flagged" title="Hours capped by shift schedule">{{ row.time_spent }} ⚠️</span>
                                {% elif row.end_time and row.end_time.strftime('%H:%M:%S') == '23:59:59' %}
                                    <span class="time-auto" title="Calculated until end of day">{{ row.time_spent }}</span>
                                {% else %}
                                    {{ row.time_spent }}
                                {% endif %}
                            </td>
                            <td>
                                {% if row.shift_name %}
                                    <strong>{{ row.shift_name }}</strong><br>
                                    <small>{{ row.shift_start }} - {{ row.shift_end }}</small>
                                {% else %}
                                    <small style="color: #a0aec0;">No shift assigned</small>
                                {% endif %}
                            </td>
                            <td>
                                {% if row.shift_flag == "late checkout" %}
                                    <span class="status-badge status-late-checkout" title="Late checkout - at or past shift end (or 12:00 if no shift)">LATE CHECKOUT</span>
                                {% elif row.shift_flag == "late in" %}
                                    <span class="status-badge status-late-in" title="Late check-in - at or after shift start time">LATE IN</span>
                                {% elif row.shift_flag == "early out" %}
                                    <span class="status-badge status-early-out">EARLY OUT</span>
                                {% elif row.shift_capped %}
                                    <span class="status-badge status-capped">SHIFT CAPPED</span>
                                {% elif row.shift_flag == "on time" %}
                                    <span class="status-badge status-normal">ON TIME</span>
                                {% else %}
                                    <span class="status-badge status-normal">NORMAL</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="no-data">
                    <span>📋</span> No attendance data available for the selected filters.
                </div>
            {% endif %}

            <div style="margin: 48px 0 32px 0;">
                <h2 class="section-title">
                    <span>📝</span> Raw Attendance Records
                </h2>
                <div style="margin-bottom: 12px; font-size: 0.875rem; color: #6b7280;">
                    Complete log of all fingerprint scanner entries and exits
                </div>
            </div>
            {% if attendences %}
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            {% for col in attendences[0].keys() %}
                            <th>{{ col|title }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in attendences %}
                        <tr>
                            {% for value in row.values() %}
                            <td>{{ value }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
                <div class="no-data">
                    <span>📝</span> No raw attendance records available for the selected filters.
                </div>
            {% endif %}
        </div>
    </div>
    
    <script>
        // Searchable dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchableDropdowns = document.querySelectorAll('.searchable-dropdown');
            
            searchableDropdowns.forEach(dropdown => {
                const input = dropdown.querySelector('.search-input');
                const dropdownList = dropdown.querySelector('.dropdown-list');
                const items = dropdownList.querySelectorAll('.dropdown-item');
                
                // Show dropdown when input is focused
                input.addEventListener('focus', function() {
                    dropdownList.style.display = 'block';
                    filterItems('');
                });
                
                // Filter items as user types
                input.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    filterItems(searchTerm);
                    dropdownList.style.display = 'block';
                });
                
                // Handle item selection
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        input.value = this.getAttribute('data-value');
                        dropdownList.style.display = 'none';
                        
                        // Remove selected class from all items
                        items.forEach(i => i.classList.remove('selected'));
                        // Add selected class to clicked item
                        this.classList.add('selected');
                    });
                });
                
                // Filter function
                function filterItems(searchTerm) {
                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            item.style.display = 'block';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                }
                
                // Hide dropdown when clicking outside
                document.addEventListener('click', function(event) {
                    if (!dropdown.contains(event.target)) {
                        dropdownList.style.display = 'none';
                    }
                });
                
                // Set initial selected state based on input value
                const currentValue = input.value;
                if (currentValue) {
                    items.forEach(item => {
                        if (item.getAttribute('data-value') === currentValue) {
                            item.classList.add('selected');
                        }
                    });
                }
            });
            
            // Clear error styling when user starts typing in date fields
            const dateFields = document.querySelectorAll('input[name="start_date"], input[name="end_date"]');
            dateFields.forEach(field => {
                field.addEventListener('input', function() {
                    this.style.borderColor = '';
                });
            });
        });
        
        function downloadExcel() {
            const startDate = document.querySelector('input[name="start_date"]').value;
            const endDate = document.querySelector('input[name="end_date"]').value;
            
            if (!startDate || !endDate) {
                alert('⚠️ Both start date and end date are required to download the Excel file.\n\nPlease select a date range before downloading.');
                
                // Highlight the date fields if they're empty
                const startDateField = document.querySelector('input[name="start_date"]');
                const endDateField = document.querySelector('input[name="end_date"]');
                
                if (!startDate) {
                    startDateField.style.borderColor = '#e53e3e';
                    startDateField.focus();
                }
                if (!endDate) {
                    endDateField.style.borderColor = '#e53e3e';
                    if (!startDate) {
                        setTimeout(() => endDateField.focus(), 100);
                    } else {
                        endDateField.focus();
                    }
                }
                
                // Reset border color after 3 seconds
                setTimeout(() => {
                    startDateField.style.borderColor = '';
                    endDateField.style.borderColor = '';
                }, 3000);
                
                return;
            }
            
            // If validation passes, construct the download URL
            const employeeId = document.querySelector('select[name="employee_id"]').value;
            const branchName = document.querySelector('input[name="branch_name"]').value;
            const employeeBranch = document.querySelector('input[name="employee_branch"]').value;
            const employeeName = document.querySelector('input[name="employee_name"]').value;
            const designation = document.querySelector('input[name="designation"]').value;
            
            const params = new URLSearchParams({
                start_date: startDate,
                end_date: endDate,
                employee_id: employeeId,
                branch_name: branchName,
                employee_branch: employeeBranch,
                employee_name: employeeName,
                designation: designation
            });
            
            window.location.href = `/download_xlsx?${params.toString()}`;
        }
    </script>
</body>
</html>
